# Портфельные признаки для нейросети

## Обзор

Система теперь поддерживает интеграцию данных портфеля и P&L в нейросеть для более точного анализа и принятия торговых решений. Нейросеть учитывает:

- Текущее состояние портфеля
- Прибыли и убытки по позициям
- Рисковые метрики
- Концентрацию портфеля
- Временные характеристики торгов

## Новые компоненты

### 1. PortfolioFeatureExtractor

Класс для извлечения портфельных признаков из менеджера портфеля.

**Основные признаки:**

#### Общие метрики портфеля
- `portfolio_total_value` - общая стоимость портфеля
- `portfolio_cash_balance` - баланс денежных средств
- `portfolio_invested_value` - стоимость инвестированных средств
- `portfolio_total_pnl` - общая прибыль/убыток
- `portfolio_total_pnl_percent` - P&L в процентах
- `portfolio_realized_pnl` - реализованная прибыль
- `portfolio_unrealized_pnl` - нереализованная прибыль

#### Рисковые метрики
- `portfolio_sharpe_ratio` - коэффициент Шарпа
- `portfolio_max_drawdown` - максимальная просадка
- `portfolio_volatility` - волатильность портфеля
- `portfolio_var_95` - Value at Risk (95%)

#### Позиционные признаки
- `portfolio_position_count` - количество позиций
- `portfolio_max_position_weight` - максимальный вес позиции
- `portfolio_concentration_risk` - индекс концентрации риска
- `portfolio_winning_positions` - количество прибыльных позиций
- `portfolio_losing_positions` - количество убыточных позиций
- `portfolio_avg_position_pnl` - средний P&L по позициям
- `portfolio_avg_position_pnl_percent` - средний P&L в процентах

#### Временные признаки
- `portfolio_days_since_last_trade` - дни с последней сделки
- `portfolio_age_days` - возраст портфеля в днях
- `portfolio_recent_trades_count` - количество недавних сделок

#### Рыночные признаки
- `portfolio_beta` - бета портфеля
- `portfolio_correlation_with_market` - корреляция с рынком

#### Признаки по символам
- `portfolio_position_weight` - вес позиции в портфеле
- `portfolio_position_pnl` - P&L по позиции
- `portfolio_position_pnl_percent` - P&L в процентах
- `portfolio_position_duration_days` - длительность позиции
- `portfolio_position_size` - размер позиции
- `portfolio_avg_price_vs_current` - отношение средней цены к текущей

### 2. Интеграция с нейросетями

Все нейросети (XGBoost, DeepSeek) теперь поддерживают портфельные признаки:

#### XGBoost
- Портфельные признаки добавляются как дополнительные колонки в DataFrame
- Модель обучается на расширенном наборе признаков
- Предсказания учитывают текущее состояние портфеля

#### DeepSeek
- Портфельные данные передаются в промпт для анализа
- AI учитывает контекст портфеля при принятии решений
- Анализ включает рисковые метрики и концентрацию

### 3. Обновленная архитектура

```
Market Data + Portfolio Data → Enhanced Features → Neural Networks → Predictions
```

## Конфигурация

В `config/main.yaml` добавлены настройки портфельных признаков:

```yaml
neural_networks:
  # ... другие настройки ...
  
  # Настройки портфельных признаков
  portfolio_features:
    lookback_days: 30          # Период для анализа истории
    risk_free_rate: 0.05       # Безрисковая ставка (5%)
    var_confidence: 0.95       # Уровень доверия для VaR
```

## Использование

### Автоматическая интеграция

Портфельные признаки автоматически включаются в анализ при запуске системы:

```python
# В InvestmentSystem._analysis_loop()
predictions = await self.network_manager.analyze(market_data, self.portfolio_manager)
```

### Ручное извлечение признаков

```python
from src.neural_networks.portfolio_features import PortfolioFeatureExtractor

# Создание извлекателя
extractor = PortfolioFeatureExtractor(config)

# Извлечение признаков
features = extractor.extract_portfolio_features(portfolio_manager, symbol="SBER")

# Конвертация в DataFrame
df = extractor.features_to_dataframe(features)
```

## Преимущества

### 1. Контекстное принятие решений
- Нейросеть учитывает текущее состояние портфеля
- Решения адаптируются к рисковому профилю
- Учитывается концентрация и диверсификация

### 2. Улучшенное управление рисками
- Анализ корреляции между позициями
- Учет максимальной просадки
- Контроль концентрации риска

### 3. Персонализированные сигналы
- Сигналы адаптируются к стилю торговли
- Учитывается история успешных/неуспешных сделок
- Анализ временных паттернов торговли

## Примеры использования

### Анализ концентрации риска
```python
# Нейросеть может рекомендовать диверсификацию
if portfolio_features.concentration_risk > 0.5:
    # Рекомендация снизить концентрацию
    signal = "DIVERSIFY"
```

### Учет P&L в решениях
```python
# Если портфель в убытке, более консервативные решения
if portfolio_features.total_pnl < 0:
    # Повышенные требования к уверенности
    confidence_threshold = 0.8
```

### Анализ временных паттернов
```python
# Если давно не торговали, более агрессивные сигналы
if portfolio_features.days_since_last_trade > 7:
    # Снижение порога для входа
    entry_threshold = 0.4
```

## Тестирование

Запустите тест интеграции:

```bash
python examples/test_portfolio_features.py
```

Тест проверяет:
- Извлечение портфельных признаков
- Конвертацию в DataFrame
- Интеграцию с нейросетями
- Корректность анализа

## Мониторинг

Портфельные признаки логируются в категории:
- `portfolio_indicators` - для анализа важности признаков
- Отдельные метрики в логах системы

## Ограничения

1. **Производительность**: Дополнительные вычисления могут замедлить анализ
2. **Память**: Хранение портфельных данных требует дополнительной памяти
3. **Сложность**: Увеличение количества признаков может усложнить обучение

## Будущие улучшения

1. **Машинное обучение на портфельных данных**: Специальные модели для анализа портфеля
2. **Предиктивные признаки**: Прогнозирование будущих состояний портфеля
3. **Оптимизация**: Автоматическая настройка весов портфельных признаков
4. **Визуализация**: Графики важности портфельных признаков
