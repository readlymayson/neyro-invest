# 🚀 Расширенный T-Bank провайдер данных

## 📊 Обзор новых возможностей

Система была полностью модернизирована для использования T-Bank API как основного источника данных с поддержкой:

### ✅ **Что добавлено:**

1. **📈 Стакан заявок (Order Book)**
   - Глубина стакана до 10 уровней
   - Спреды и метрики ликвидности
   - Дисбаланс объемов покупки/продажи
   - Концентрация объема по ценам

2. **🔍 Расширенные рыночные данные**
   - Реальные OHLCV данные из T-Bank
   - Информация об инструментах
   - Статус торгов
   - Валютные пары

3. **🧠 50+ признаков для нейросети**
   - Стандартные технические индикаторы (30+)
   - Признаки стакана заявок (10+)
   - Объемные индикаторы (10+)
   - Временные признаки (5+)
   - Микроструктурные признаки (5+)

4. **🔄 Множественные источники данных**
   - T-Bank API (основной)
   - YFinance (резервный)
   - Российский провайдер (fallback)
   - Автоматическое переключение

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    DataProvider                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐  │
│  │ EnhancedTBank  │  │ MultiProvider   │  │ YFinance     │  │
│  │ Provider       │  │ DataProvider    │  │ Provider     │  │
│  └─────────────────┘  └─────────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           EnhancedFeatureExtractor                     │ │
│  │  • Технические индикаторы (30+)                       │ │
│  │  • Признаки стакана заявок (10+)                      │ │
│  │  • Объемные индикаторы (10+)                          │ │
│  │  • Временные признаки (5+)                            │ │
│  │  • Микроструктурные признаки (5+)                     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📋 Новые файлы

### 1. **`src/data/enhanced_tbank_provider.py`**
- Расширенный T-Bank провайдер
- Поддержка стакана заявок
- Множественные источники данных
- Кэширование данных

### 2. **`src/neural_networks/enhanced_features.py`**
- Извлечение 50+ признаков
- Признаки стакана заявок
- Объемные индикаторы
- Временные признаки

### 3. **`config/tbank_enhanced.yaml`**
- Конфигурация для T-Bank провайдера
- Настройки расширенных возможностей
- Параметры нейросетей

### 4. **`scripts/test_enhanced_tbank_provider.py`**
- Тестирование новых возможностей
- Проверка стакана заявок
- Валидация признаков

## 🔧 Настройка и использование

### 1. **Установка зависимостей**
```bash
pip install tinkoff-investments
```

### 2. **Настройка токена**
```bash
# Windows
set TINKOFF_TOKEN=your_token_here

# Linux/Mac
export TINKOFF_TOKEN=your_token_here
```

### 3. **Использование в коде**
```python
from src.data.data_provider import DataProvider

# Конфигурация для T-Bank провайдера
config = {
    'provider': 'tbank',
    'symbols': ['SBER', 'GAZP', 'LKOH'],
    'tbank_token': os.environ.get('TINKOFF_TOKEN'),
    'tbank_sandbox': True,
    'update_interval': 60
}

# Создание провайдера
data_provider = DataProvider(config)
await data_provider.initialize()

# Получение расширенных данных
enhanced_data = await data_provider.get_enhanced_features('SBER')
```

## 📊 Новые возможности данных

### **Стакан заявок (Order Book)**
```python
orderbook = await provider.get_orderbook('SBER', depth=10)

# Доступные данные:
{
    'bids': [{'price': 250.0, 'quantity': 1000}, ...],
    'asks': [{'price': 250.5, 'quantity': 500}, ...],
    'spread': 0.5,                    # Спред
    'spread_percent': 0.2,            # Спред в %
    'mid_price': 250.25,              # Средняя цена
    'total_bid_volume': 5000,         # Общий объем покупки
    'total_ask_volume': 3000,        # Общий объем продажи
    'volume_imbalance': 2000,        # Дисбаланс объемов
    'bid_levels': 10,                 # Количество уровней покупки
    'ask_levels': 8                  # Количество уровней продажи
}
```

### **Расширенные признаки (50+)**

#### **Технические индикаторы (30+)**
- Скользящие средние: SMA_5, SMA_10, SMA_20, SMA_50
- Экспоненциальные средние: EMA_5, EMA_10, EMA_20, EMA_50
- Осцилляторы: RSI, MACD, Stochastic, Williams %R, CCI
- Полосы Боллинджера: BB_Upper, BB_Lower, BB_Width, BB_Position
- Волатильность: ATR, Volatility, Volatility_ratio

#### **Признаки стакана заявок (10+)**
- Spread, Spread_Percent, Mid_Price
- Total_Bid_Volume, Total_Ask_Volume, Volume_Imbalance
- Bid_Ask_Ratio, Bid_Levels, Ask_Levels
- Avg_Bid_Price, Avg_Ask_Price, Bid_Price_Std, Ask_Price_Std

#### **Объемные индикаторы (10+)**
- Volume_Ratio, Volume_Change, Volume_Change_5
- OBV (On-Balance Volume), VPT (Volume Price Trend)
- ADL (Accumulation/Distribution Line)
- MFI (Money Flow Index), EOM (Ease of Movement)

#### **Временные признаки (5+)**
- Hour, DayOfWeek, Month, Quarter
- Циклические признаки: Hour_sin, Hour_cos, DayOfWeek_sin, DayOfWeek_cos
- Торговые сессии: Is_Market_Open, Is_Morning, Is_Afternoon, Is_Evening

## 🧪 Тестирование

### **Запуск тестов**
```bash
# Windows
test_enhanced_tbank.bat

# Linux/Mac
python scripts/test_enhanced_tbank_provider.py
```

### **Что тестируется:**
1. ✅ Инициализация T-Bank провайдера
2. ✅ Получение исторических данных
3. ✅ Данные в реальном времени
4. ✅ Стакан заявок с метриками
5. ✅ Расширенные рыночные данные
6. ✅ Извлечение 50+ признаков
7. ✅ Интеграция с основным провайдером

## 📈 Преимущества новой системы

### **1. Более точные данные**
- Реальные данные из T-Bank API
- Стакан заявок для анализа ликвидности
- Микроструктурные метрики

### **2. Расширенные возможности анализа**
- 50+ признаков вместо 30
- Признаки стакана заявок
- Объемные индикаторы
- Временные паттерны

### **3. Надежность**
- Множественные источники данных
- Автоматическое переключение
- Fallback механизмы

### **4. Производительность**
- Кэширование данных
- Асинхронная обработка
- Оптимизированные запросы

## 🔄 Миграция с старой системы

### **Автоматическая миграция**
Система автоматически определяет тип провайдера по конфигурации:

```yaml
# Старая конфигурация
data:
  provider: "yfinance"  # или "russian"

# Новая конфигурация  
data:
  provider: "tbank"     # или "multi"
  tbank_token: "${TINKOFF_TOKEN}"
  tbank_sandbox: true
```

### **Обратная совместимость**
- Старые конфигурации продолжают работать
- Постепенная миграция на T-Bank API
- Fallback на старые провайдеры

## 🎯 Следующие шаги

1. **Тестирование в sandbox**
   - Запустить `test_enhanced_tbank.bat`
   - Проверить получение данных
   - Валидировать признаки

2. **Настройка production**
   - Получить production токен
   - Обновить конфигурацию
   - Переключить на реальные данные

3. **Оптимизация нейросети**
   - Обучить на новых признаках
   - Настроить веса признаков
   - Валидировать точность

---

**🚀 Система готова к использованию с расширенными возможностями T-Bank API!**
